
import argparse
from ast import literal_eval
from pathlib import Path
from typing import List
import numpy as np

actual_blosum_distance = {'A': {'A':  1.6557009493757229, 'R':  3.074488680238643, 'N':  3.247603735814866, 'D':  3.1486902912947694, 'C':  3.4373822171706765, 'Q':  3.259667778702074, 'E':  2.8493832148429132, 'G':  2.228388573476388, 'H':  3.774629696204944, 'I':  2.788924567316027, 'L':  2.484574820989069, 'K':  2.7436589402616804, 'M':  3.5962391038358463, 'F':  3.410950563434382, 'P':  3.1532558001444753, 'S':  2.1608885378560094, 'T':  2.645534339913555, 'W':  4.717777605361842, 'Y':  3.625339458894354, 'V':  2.35674280640763}, 'R': {'A':  2.7057314019873147, 'R':  1.4651580536577276, 'N':  2.8649466887189554, 'D':  3.070848802429311, 'C':  4.370464050911914, 'Q':  2.6521453974590226, 'E':  2.577383938852923, 'G':  2.994399243830336, 'H':  3.3000852421315052, 'I':  3.2979463548819172, 'L':  2.6774144466657273, 'K':  1.7949075752010997, 'M':  3.7056674230990625, 'F':  3.56705223963459, 'P':  3.5413822601306597, 'S':  2.738450966849357, 'T':  2.963427135905548, 'W':  4.736930006466227, 'Y':  3.5725459868086946, 'V':  3.074104630011239}, 'N': {'A':  2.758865313305344, 'R':  2.744965544460762, 'N':  1.5575574954688676, 'D':  2.156258628318696, 'C':  4.149994206227591, 'Q':  2.984438022834922, 'E':  2.641959261095622, 'G':  2.401703680937528, 'H':  3.0476604558264486, 'I':  3.386491628877791, 'L':  3.088314240852152, 'K':  2.5494449896557407, 'M':  3.974183086962024, 'F':  3.649413947378853, 'P':  3.5216764488342407, 'S':  2.312393013128124, 'T':  2.6309008605963844, 'W':  5.08067887295898, 'Y':  3.7131489365453856, 'V':  3.210142371976523}, 'D': {'A':  2.7854359549708705, 'R':  3.0763517443567405, 'N':  2.2817427145043196, 'D':  1.3021693693065548, 'C':  4.363184179828689, 'Q':  3.040848354005443, 'E':  2.0219015471752155, 'G':  2.6441489204685, 'H':  3.5507688043742474, 'I':  3.3101049735403976, 'L':  3.1161804277553045, 'K':  2.6729835800286663, 'M':  4.222090642243004, 'F':  3.7623061279135452, 'P':  3.308149245062416, 'S':  2.5455221739767384, 'T':  2.9101362418543726, 'W':  5.202788198266524, 'Y':  3.985464579802376, 'V':  3.2507923796464553}, 'C': {'A':  2.2990673577304035, 'R':  3.600906469722969, 'N':  3.500417769296839, 'D':  3.5881236567123147, 'C':  1.0663577739147465, 'Q':  3.8255629693058006, 'E':  3.625554721557574, 'G':  2.9759295473057463, 'H':  4.1029475438232765, 'I':  2.6464711383631165, 'L':  2.3120779261309594, 'K':  3.3756149943013956, 'M':  3.640797540225315, 'F':  3.35237612963654, 'P':  3.6813520430812057, 'S':  2.692163090967905, 'T':  2.798901259944822, 'W':  4.53376409080286, 'Y':  3.7211303082321727, 'V':  2.4444980468796635}, 'Q': {'A':  2.579302861049579, 'R':  2.3405377580578564, 'N':  2.792811527691949, 'D':  2.7237377726768472, 'C':  4.283512911093579, 'Q':  1.9786685497082728, 'E':  2.0113004182431955, 'G':  2.897226344771475, 'H':  3.145083499506138, 'I':  3.2971818731225566, 'L':  2.74125918300486, 'K':  2.1356344493731583, 'M':  3.470440472818783, 'F':  3.759739995603431, 'P':  3.3447829489295438, 'S':  2.594520788711914, 'T':  2.889502545148512, 'W':  4.570622221470756, 'Y':  3.5549135372531175, 'V':  3.0463267309360704}, 'E': {'A':  2.5542080933191507, 'R':  2.6509660955804897, 'N':  2.8355225620813815, 'D':  2.089980761975352, 'C':  4.468694459474085, 'Q':  2.396490214371928, 'E':  1.628140240925324, 'G':  2.9578153421555515, 'H':  3.283450466963861, 'I':  3.3899901494222977, 'L':  2.9270872879799086, 'K':  2.251874829431974, 'M':  3.9356237344278293, 'F':  3.724359049553963, 'P':  3.2467743660402215, 'S':  2.5648753948460175, 'T':  2.905790326903879, 'W':  4.813445938519324, 'Y':  3.704168816522439, 'V':  3.0807033800558563}, 'G': {'A':  2.0990145255586348, 'R':  3.233782474163912, 'N':  2.761068055529297, 'D':  2.8780292088746458, 'C':  3.9848703588282666, 'Q':  3.448217214506217, 'E':  3.123616415761561, 'G':  1.0, 'H':  3.7804686224584, 'I':  3.43696875602521, 'L':  3.0548341480310097, 'K':  2.8717138078766986, 'M':  4.030441274355638, 'F':  3.5724079448032935, 'P':  3.4510739777953465, 'S':  2.4874588293838573, 'T':  3.0114510454003156, 'W':  4.577836287412671, 'Y':  3.909092064632824, 'V':  3.181301143808965}, 'H': {'A':  2.768480925204488, 'R':  2.662693749382378, 'N':  2.5302501073355144, 'D':  2.90787436969769, 'C':  4.235113632263093, 'Q':  2.819299646158177, 'E':  2.5724768174871673, 'G':  2.903693899375697, 'H':  1.4328198357848065, 'I':  3.3702856010805924, 'L':  2.8760503887197197, 'K':  2.7036914699456567, 'M':  3.759528239630075, 'F':  3.059824732377602, 'P':  3.552650439422292, 'S':  2.77055075495405, 'T':  3.139899768584787, 'W':  4.62231975110781, 'Y':  2.4725675025556813, 'V':  3.267163429706885}, 'I': {'A':  2.7160618869899915, 'R':  3.5938409528072106, 'N':  3.802367371061278, 'D':  3.600496629538261, 'C':  3.7119233174773547, 'Q':  3.904684110449017, 'E':  3.6123025906200246, 'G':  3.4934801236169277, 'H':  4.303571691755013, 'I':  1.7258087003582012, 'L':  1.5294287849380463, 'K':  3.3791444674719635, 'M':  2.939724132120281, 'F':  2.758600530337872, 'P':  3.790770070906455, 'S':  3.2900809190332345, 'T':  2.8725952321779595, 'W':  4.744951204956301, 'Y':  3.4953653228500436, 'V':  1.4822942655905311}, 'L': {'A':  2.704347217149074, 'R':  3.2659441210770606, 'N':  3.7968250595216784, 'D':  3.6992071602392076, 'C':  3.6701651817312375, 'Q':  3.6413964968173596, 'E':  3.4420348056636754, 'G':  3.403980592108767, 'H':  4.10197155588018, 'I':  1.8220638614240858, 'L':  1.3656408936366689, 'K':  3.249125010369607, 'M':  2.6023611604056973, 'F':  2.5147255735372194, 'P':  3.7663317641332283, 'S':  3.2627448944425828, 'T':  2.9698198636323574, 'W':  4.380543100014428, 'Y':  3.3504887078414907, 'V':  1.9927265470696123}, 'K': {'A':  2.5231213219146356, 'R':  1.943127235105383, 'N':  2.817645793818218, 'D':  2.8157002980055204, 'C':  4.293392235394624, 'Q':  2.5954617486786087, 'E':  2.3265123326086914, 'G':  2.780550237447407, 'H':  3.4893026225990673, 'I':  3.2314695294509534, 'L':  2.8088149958625577, 'K':  1.703966010586821, 'M':  3.738628959974603, 'F':  3.698481200925108, 'P':  3.22451857252942, 'S':  2.5940225126481273, 'T':  2.8540786204738806, 'W':  4.863421985518262, 'Y':  3.650281109289754, 'V':  3.0334399954914644}, 'M': {'A':  2.648453034373413, 'R':  3.126638631887958, 'N':  3.5151354400091126, 'D':  3.6375589091044693, 'C':  3.831326330203155, 'Q':  3.2030193210088442, 'E':  3.283012786489158, 'G':  3.2120292528109577, 'H':  3.817890941168098, 'I':  2.0648007429838824, 'L':  1.4348026947832593, 'K':  3.0113805088592147, 'M':  2.264826826457774, 'F':  2.7598475508554143, 'P':  3.7575157451395937, 'S':  3.0671161021139395, 'T':  2.9133227476144867, 'W':  4.428778939594811, 'Y':  3.44393049276722, 'V':  2.1405856228633686}, 'F': {'A':  2.939518513732235, 'R':  3.4643774681837716, 'N':  3.666720320186228, 'D':  3.654128414535297, 'C':  4.019258939374667, 'Q':  3.968672863553779, 'E':  3.548102121375578, 'G':  3.2303499430188993, 'H':  3.594541453675911, 'I':  2.3600311609617597, 'L':  1.823521127675068, 'K':  3.447586769570006, 'M':  3.2362015706157012, 'F':  1.335560081757655, 'P':  3.9988407584324883, 'S':  3.233241391617201, 'T':  3.258206925405215, 'W':  3.5509752484811443, 'Y':  2.0517942608541793, 'V':  2.5161491501872453}, 'P': {'A':  2.42312853448677, 'R':  3.180012272724283, 'N':  3.2802876056860573, 'D':  2.9412763157286093, 'C':  4.089539636863774, 'Q':  3.2950206009243335, 'E':  2.8118222219062785, 'G':  2.850320760055394, 'H':  3.828671944765043, 'I':  3.1335054855747844, 'L':  2.816432102315518, 'K':  2.71492892521876, 'M':  3.9751745489443224, 'F':  3.7401455424769297, 'P':  1.0374916405280687, 'S':  2.6637734198834644, 'T':  2.859262396848311, 'W':  4.962971855895896, 'Y':  3.8797322151165163, 'V':  2.9354185967024895}, 'S': {'A':  1.955800797722854, 'R':  2.9021205049675296, 'N':  2.5960436955044908, 'D':  2.7036887701674814, 'C':  3.6253902102750226, 'Q':  3.069797966231253, 'E':  2.6549627762366237, 'G':  2.4117451371684546, 'H':  3.57161178582135, 'I':  3.157855859226114, 'L':  2.837884758149422, 'K':  2.6094723908620168, 'M':  3.8098144314432174, 'F':  3.499585701186192, 'P':  3.188812945408014, 'S':  1.9497845198428596, 'T':  2.221830059443998, 'W':  4.827743507635342, 'Y':  3.637331680332402, 'V':  2.864761713961506}, 'T': {'A':  2.3172985017105985, 'R':  3.003948575953919, 'N':  2.791403444902949, 'D':  2.9451547399753144, 'C':  3.6089802811821383, 'Q':  3.24163162459805, 'E':  2.872729610224684, 'G':  2.8125892551151113, 'H':  3.817812701382285, 'I':  2.6172220743010377, 'L':  2.4218116292693956, 'K':  2.7463804006179684, 'M':  3.532872978873963, 'F':  3.401403136904405, 'P':  3.261153824303059, 'S':  2.0986819613741963, 'T':  1.8319204406191405, 'W':  4.709675574249089, 'Y':  3.5978261796321243, 'V':  2.3370206717840842}, 'W': {'A':  2.9517370639950276, 'R':  3.33964674335074, 'N':  3.803376754101687, 'D':  3.8000019932236073, 'C':  3.9060384088763183, 'Q':  3.484946597756436, 'E':  3.342580518676271, 'G':  2.9411697939636086, 'H':  3.8624279807414506, 'I':  3.0517733439155212, 'L':  2.3947301624876083, 'K':  3.317919062498492, 'M':  3.6105244676904293, 'F':  2.256366756816476, 'P':  3.927058580186786, 'S':  3.2667907064016823, 'T':  3.2718708710852322, 'W':  1.0092673547678124, 'Y':  2.2152683398149344, 'V':  4.162317285953955}, 'Y': {'A':  2.8338794415235053, 'R':  3.1498432476891742, 'N':  3.4104273416840587, 'D':  3.5572588987554252, 'C':  4.067985150301597, 'Q':  3.443818437534764, 'E':  3.2078839206753527, 'G':  3.247006095179728, 'H':  2.687256256185289, 'I':  2.77676798580523, 'L':  2.3392562943106374, 'K':  3.07935871026595, 'M':  3.600256544858805, 'F':  1.7317662931854776, 'P':  3.8183994634033733, 'S':  3.0509594030947085, 'T':  3.1346020004642328, 'W':  3.189848863810901, 'Y':  1.5551922727819278, 'V':  2.670488104205731}, 'V': {'A':  2.3565717730650078, 'R':  3.442690874919945, 'N':  3.698709761143423, 'D':  3.613875682627732, 'C':  3.582641872977315, 'Q':  3.726520615245943, 'E':  3.3757074682369965, 'G':  3.310504158384096, 'H':  4.273141167364718, 'I':  1.5549859125739438, 'L':  1.7727831175669855, 'K':  3.2538065804958873, 'M':  3.08820065898318, 'F':  2.9874101665467703, 'P':  3.6653748290175727, 'S':  3.06967842075204, 'T':  2.6650854766444194, 'W':  4.191212198274309, 'Y':  3.4617770882339576, 'V':  1.7401769709595234}}
for char in actual_blosum_distance:
    actual_blosum_distance[char][char]=0
    actual_blosum_distance[char]["X"]=0

def dump_msa_to_file(msa:List[str], path:Path):
    path.parent.mkdir(parents=True,exist_ok=True)
    with open(path, "w") as f:
        f.write("\n".join(msa)+"\n")

def read_msa_from_file(path:Path):
  with open(path, "r") as f:
    return f.read().split("\n")

def sequences_from_msa(msa:List[str]):
  return [line for line in msa if not line.startswith(">")]

def compute_dist(starting_seq, ending_seq, blosum_dist, start=None, end=None):
    #assume sequences are already aligned and just drop inserts
    starting_seq = [char for char in starting_seq if (char.isupper() or char=="-")][start:end]
    #starting_seq = [char for char in starting_seq if (char.isupper() or char=="-")]
    #print(f"{starting_seq[:start]}-{starting_seq[start:end]}-{starting_seq[end:]}")
    #starting_seq = starting_seq[start:end]
    ending_seq = [char for char in ending_seq if (char.isupper() or char=="-")][start:end]
    distance=None
    for it, start_char in enumerate(starting_seq):
        if start_char != "-" and ending_seq[it] != "-":
            distance = 0 if distance is None else distance
            distance += blosum_dist[start_char][ending_seq[it]]
    return distance

def split_a3m(a3m, parent_path, blosum_distance, parties, start=None, end=None):
    #for (party_name, party_seq) in parties:
    result_a3ms = [[],[]]
    for line in set(a3m):
        distances = [compute_dist(party_seq, line, blosum_distance, start, end) for (party_name, party_seq) in parties]
        for it, distance in enumerate(distances):
            if distance == 0:
                result_a3ms[it].append(line)
#        result_a3ms[np.argmin(distances)].append(line)
    for it, (party_name, party_seq) in enumerate(parties):
        dump_msa_to_file([">inp",party_seq]+ [elem for result in result_a3ms[it] for elem in (">filtered", result) ], parent_path/f"split_{party_name}.a3m")

if __name__ == "__main__":
    p = argparse.ArgumentParser(description=
    """
    Jannik
    """)
    p.add_argument("--a3m_path", action="store", help="Path to input a3m.")
    p.add_argument("--parent_path", action='store', help='Parentpath to save outputs')
    p.add_argument("--parties", action="store", help='All parties to split to.')
    p.add_argument("--start", action="store", help='Starting position (0-indexed)')
    p.add_argument("--end", action="store", help='Ending position (0-indexed)')
    args = p.parse_args()
    a3m_path = Path(args.a3m_path)
    parent_path = Path(args.parent_path)
    start = int(args.start) if "start" in args else None
    end = int(args.end) if "end" in args else None 
    parties = literal_eval(args.parties)
    parties = [(name, read_msa_from_file(path)[1]) for (name,path) in parties]
    msa = []
    for msa_path in a3m_path.glob("*.a3m"):
        msa = msa + read_msa_from_file(msa_path)[1::2]
    split_a3m(msa, parent_path, actual_blosum_distance, parties, start, end)
    


#python split_a3m.py --a3m_path ${CURR_PATH}/a3ms --parent_path ${CURR_PATH} --parties [("wild", $CURR_PATH/wild.fasta), ($MUT_ID,$CURR_PATH/${MUT_ID}.fasta)]